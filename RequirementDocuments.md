# B站DASH音频解析服务工具需求文档（博客集成版）

## 一、项目目标
开发一个无前端界面的后端服务工具，为博客网站提供B站音频解析能力，支持通过BV号获取DASH格式音频资源，替代官方iframe嵌入方式，使博客可自定义音频播放样式。工具需实现账号登录（含SESSDATA登录）功能，模拟合法用户行为获取音频资源，确保服务稳定性与合规性。


## 二、核心功能需求

### 1. 资源解析服务
- **BV号解析接口**：提供HTTP/API接口，接收B站BV号作为输入，返回对应视频的DASH格式音频资源信息（支持批量解析）。
- **音频质量筛选**：解析接口支持用户指定音频质量参数（如标准音质、高清音质、Hi-Res无损等），返回对应质量的m4s音频切片链接及元数据（编码格式、比特率、时长等）。
- **资源权限校验**：自动识别音频视频是否需要会员权限，对需权限的资源，仅在登录账号拥有对应权限时返回有效链接。


### 2. 登录认证管理
- **多登录方式支持**：
  - 账号密码登录：提供接口接收账号/密码，处理验证码、短信验证等风控场景，返回登录状态凭证。
  - SESSDATA登录：支持直接直接传入B站Cookie中的SESSDATA等关键参数进行身份验证，无需重复登录。
  - 登录状态持久化：自动维护登录状态，实现凭证过期时自动刷新，减少重复登录操作。
- **凭证安全存储**：对登录凭证（Cookie、Token等）进行加密存储，支持多账号管理（区分不同博客用户的登录状态）。


### 3. 请求与防盗链处理
- **接口适配与签名**：
  - 调用B站官方播放地址接口（如`https://api.bilibili.com/x/player/wbi/playurl`），自动处理WBI参数签名，确保请求合法性。
  - 传递`fnval=4048`（DASH格式标识）等参数，强制接口返回音频切片（m4s）链接。
- **防盗链规避**：
  - 模拟浏览器请求头（`User-Agent`、`Referer`设为博客域名或B站官方域名），避免请求被直接拦截。
  - 处理接口返回的时效性参数（`sign`、`expires`等），确保音频链接在有效期内可用。
- **风控应对**：
  - 实现浏览器指纹生成逻辑，模拟真实设备环境，降低风控概率。
  - 当触发风控（如412状态码）时，返回明确的错误信息，支持通过API接口引导用户完成验证（如滑块验证）。


### 4. 服务化能力
- **API接口设计**：
  - 提供清晰的RESTful API，包含登录、解析、状态查询等端点（参考文档见附录）。
  - 支持跨域请求（CORS配置），允许博客前端直接调用接口。
- **缓存机制**：
  - 对已解析的音频资源信息进行缓存（用户自行配置，默认1小时），减少重复请求，提升响应速度。
  - 缓存Key包含BV号、音质参数、登录状态，确保资源一致性。
- **日志与监控**：
  - 记录关键操作日志（请求时间、BV号、状态码、错误信息等），**便于问题排查**。
  - 提供服务健康检查接口，返回当前服务状态、登录账号有效性等信息。


## 三、非功能性需求

### 1. 兼容性
- 支持主流操作系统（Windows Server、Linux、macOS Server），可作为后台服务常驻运行。
- 适配B站接口更新，当接口参数或签名算法变更时，能通过配置调整或版本更新快速适配。


### 2. 安全性
- 不存储用户明文密码，登录凭证采用加密方式存储（如AES加密），密钥需安全管理。
- 限制单IP/账号的请求频率（如每分钟最多20次解析请求），防止滥用导致账号风险。
- 接口通信支持HTTPS，避免凭证或音频链接在传输过程中被窃取。


### 3. 稳定性
- 实现请求重试机制，对临时网络错误或接口超时进行自动重试（最多3次）。
- 当B站接口返回无效数据时，返回标准化错误信息（如`{"code":403,"msg":"权限不足"}`），便于博客前端处理。


## 四、约束与声明
- 工具仅用于技术学习与合法博客内容展示，用户需遵守B站用户协议及《著作权法》，不得解析或传播受版权保护的内容。
- 音频资源的获取依赖用户已合法拥有的权限（如会员订阅），工具不提供绕过权限的功能。
- 因B站接口政策变更可能导致服务失效，需定期维护接口适配逻辑。


## 附录：API接口参考
| 端点 | 方法 | 描述 | 参数 | 返回值 |
|------|------|------|------|--------|
| `/api/login` | POST | 账号登录 | `{ username, password, captcha? }` | `{ success: boolean, token: string, expires: number }` |
| `/api/login/sessdata` | POST | SESSDATA登录 | `{ sessdata, bili_jct, dedeuserid }` | `{ success: boolean, token: string, expires: number }` |
| `/api/parse` | GET | 解析音频资源 | `{ bv: string, quality?: number, token }` | `{ success: boolean, audio: { url: string, format: string, bitrate: number, duration: number } }` |
| `/api/status` | GET | 服务状态查询 | - | `{ alive: boolean, loginStatus: Record<string, "valid"|"expired"> }` |